#!/usr/bin/python

import logging
import yaml
import asyncio
import os
import subprocess
import time

def logger():
    try:
        log = logging.getLogger(__name__)
        log.setLevel(logging.DEBUG)
        home_dir = os.path.expanduser("~")
        log_path = os.path.join(home_dir, ".vasak-session.log")
        file_handler = logging.FileHandler(log_path, mode='w')
        formatter = logging.Formatter(
            '%(asctime)s : %(levelname)s : %(name)s : %(message)s')
        file_handler.setFormatter(formatter)
        log.addHandler(file_handler)
        return log
    except PermissionError:
        print("No permission to write log")
        return False

def wait_for_bluetooth():
    """Espera hasta que el servicio bluetooth esté activo."""
    while True:
        result = subprocess.run(
            ["systemctl", "is-active", "--quiet", "bluetooth.service"]
        )
        if result.returncode == 0:
            if log:
                log.info("bluetooth.service está activo")
            break
        else:
            if log:
                log.debug("Esperando bluetooth.service...")
            time.sleep(1)


log = logger()


def load_settings():
    session_path = "/etc/vasak/session-x11.yaml"
    wait_for_bluetooth()
    try:
        with open(session_path) as f:
            return yaml.load(f, Loader=yaml.FullLoader)
    except FileNotFoundError:
        output = f"{session_path} not found"
        if log:
            log.info(output)
        else:
            print(output)


async def run(cmd, restart=False):
    proc = await asyncio.create_subprocess_shell(
        cmd,
        stdout=asyncio.subprocess.PIPE,
        stderr=asyncio.subprocess.PIPE,
    )

    stdout, stderr = await proc.communicate()
    returncode = f'{cmd} exited with code {proc.returncode}'
    if log:
        log.info(returncode)
    else:
        print(returncode)

    if stdout:
        output = f'pid: {proc.pid}\n{stdout.decode()}'
        if log:
            log.debug(output)
        else:
            print(output)
    if stderr:
        output = f'pid: {proc.pid}\n{stderr.decode()}'
        if log:
            log.debug(output)
        else:
            print(output)


def session():
    vde = load_settings().get("vde")
    wm = load_settings().get("wm")
    dex = load_settings().get("dex")
    tasks = [run(wm[0], restart=True)]
    for task in vde:
        tasks.append(run(task, restart=True))

    tasks.append(run(dex[0]))

    async def procs():
        await asyncio.gather(*tasks)

    asyncio.run(procs())


session()
